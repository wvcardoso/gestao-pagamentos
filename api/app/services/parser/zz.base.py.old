from api.app.services.parser import manual
from api.app.services.parser import neoenergia
from api.app.services.parser import caesb
from app.core.utils import (
    extrair_texto_pdf,
    extrair_texto_txt,
    identificar_favorecido,
    extrair_qrcode_pdf,
    encontrar_residencia_por_codigo,
    carregar_residencias,
)

from api.app.services.parser import simplesnacional

PARSERS = {
    "neoenergia": neoenergia,
    "caesb": caesb,
    "simplesnacional": simplesnacional,
}

def processar(caminho):

    mapa_residencias = carregar_residencias()

    # =========================
    # üìÑ PDF
    # =========================
    if caminho.endswith(".pdf"):

        texto = extrair_texto_pdf(caminho)
        
        #print(texto)
        
        favorecido = identificar_favorecido(texto)

        parser = PARSERS.get(favorecido)

        if not parser:
            print("‚ùå Parser n√£o encontrado")
            return None

        dados = parser.parse(texto)

        # QR Code
        qr = extrair_qrcode_pdf(caminho)
        if qr:
            dados["pix_payload"] = qr

        # favorecido
        dados["favorecido"] = favorecido

        # resid√™ncia
        unidade = dados.get("unidade_consumidora")

        if unidade:
            unidade = str(unidade).strip()
            residencia = encontrar_residencia_por_codigo(unidade, mapa_residencias)
        else:            
            residencia = "Desconhecida"

        dados["residencia"] = residencia

        return dados

    # =========================
    # üìù TXT
    # =========================
    elif caminho.endswith(".txt"):

        texto = extrair_texto_txt(caminho)
        dados = manual.parse(texto)

        # favorecido
        #dados["favorecido"] = favorecido

        # resid√™ncia
        unidade = dados.get("unidade_consumidora")

        if unidade:
            unidade = str(unidade).strip()            
            residencia = encontrar_residencia_por_codigo(unidade, mapa_residencias)
        else:            
            residencia = "desconhecida" # ou n√£o se aplica!!!

        dados["residencia"] = residencia
        
        pix = dados.get("pix")
        if pix:
            dados["pix_payload"] = pix

        return dados

    else:
        print("‚ö†Ô∏è Tipo de arquivo n√£o suportado")
        return None
