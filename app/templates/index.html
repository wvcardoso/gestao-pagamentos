<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Contas</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

    <!-- ðŸ” HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸ“Š Dashboard de Contas</h2>

        <div>
            <span class="me-3">ðŸ‘¤ {{ session.get("usuario", "admin") }}</span>
            <a href="/logout" class="btn btn-danger btn-sm">Sair</a>
        </div>
    </div>

    <!-- ðŸ” FILTROS -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <form method="get" class="row g-3 align-items-end">

                <!-- STATUS -->
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos</option>

                        <option value="pendente"
                            {% if status_selecionado == "pendente" %}selected{% endif %}>
                            Pendente
                        </option>

                        <option value="pago"
                            {% if status_selecionado == "pago" %}selected{% endif %}>
                            Pago
                        </option>
                    </select>
                </div>

                <!-- RESIDÃŠNCIA -->
                <div class="col-md-4">
                    <label class="form-label">ResidÃªncia</label>
                    <select name="residencia" class="form-select" onchange="this.form.submit()">
                        <option value="">Todas</option>

                        {% for r in residencias %}
                        <option value="{{ r }}"
                            {% if residencia_selecionada == r %}selected{% endif %}>
                            {{ r }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- LIMPAR -->
                <div class="col-md-2">
                    <a href="/" class="btn btn-secondary w-100">Limpar</a>
                </div>

            </form>

        </div>
    </div>

    <!-- ðŸ”¥ CARDS -->
    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card text-white bg-danger shadow">
                <div class="card-body">
                    <h6>Total Pendente</h6>
                    <h3>R$ {{ "%.2f"|format(total_pendente) }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-success shadow">
                <div class="card-body">
                    <h6>Total Pago</h6>
                    <h3>R$ {{ "%.2f"|format(total_pago) }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-primary shadow">
                <div class="card-body">
                    <h6>Total de Contas</h6>
                    <h3>{{ total_contas }}</h3>
                </div>
            </div>
        </div>

    </div>

    <!-- ðŸ“‹ TABELA -->
    <div class="card shadow">
        <div class="card-body p-0">

            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>ResidÃªncia</th>
                        <th>Favorecido</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>AÃ§Ã£o</th>
                        <th>PIX</th>
                    </tr>
                </thead>

                <tbody>
                    {% for c in contas %}
                    <tr>
                        <td>{{ c.id }}</td>
                        <td>{{ c.residencia }}</td>
                        <td>{{ c.favorecido }}</td>
                        <td>{{ c.tipo }}</td>

                        <td>
                            <strong>R$ {{ "%.2f"|format(c.valor or 0) }}</strong>
                        </td>

                        <td>{{ c.vencimento }}</td>

                        <td>
                            {% if c.status == 'pago' %}
                                <span class="badge bg-success">Pago</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Pendente</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if c.status != 'pago' %}
                                <a href="/pagar/{{ c.id }}" class="btn btn-sm btn-success">
                                    âœ” Pagar
                                </a>
                            {% endif %}
                        </td>

                        <td>
                            {% if c.pix_payload %}
                                <button class="btn btn-sm btn-primary"
                                        onclick="abrirQR(`{{ c.pix_payload }}`)">
                                    ðŸ”³ QR
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>

        </div>
    </div>

</div>

<!-- ðŸ”³ MODAL QR -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">

      <div class="modal-header">
        <h5 class="modal-title">Pagamento via PIX</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="qrImage" src="" class="img-fluid mb-3">

        <textarea id="pixCode" class="form-control" rows="3" readonly></textarea>

        <button class="btn btn-secondary mt-2" onclick="copiarPix()">
            ðŸ“‹ Copiar PIX
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JS -->
<script>
function abrirQR(payload) {

    const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(payload);

    document.getElementById("qrImage").src = qrUrl;
    document.getElementById("pixCode").value = payload;

    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
}

function copiarPix() {
    const pix = document.getElementById("pixCode");
    pix.select();
    document.execCommand("copy");
    alert("PIX copiado!");
}
</script>

</body>
</html>
