<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <meta charset="UTF-8">
    <title>Gest√£o de Contas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    

    <style>
        body {
            overflow-x: hidden;
        }

        .sidebar {
            height: 100vh;
            width: 220px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #343a40;
            padding-top: 20px;
        }

        .sidebar a {
            color: #ddd;
            padding: 10px 20px;
            display: block;
            text-decoration: none;
        }

        .sidebar a:hover {
            background-color: #495057;
            color: #fff;
        }

        .content {
            margin-left: 220px;
            padding: 20px;
        }
    </style>
</head>

<body>

<!-- üîπ SIDEBAR -->
<div class="sidebar">
    <h4 class="text-white text-center">üìä Sistema</h4>
    <hr class="bg-light">

    <a href="/">üè† Dashboard</a>
    <a href="#">‚öôÔ∏è Processamento</a>
    <a href="#">üí∞ Contas</a>
    <a href="#">üë§ Usu√°rios</a>
    <a href="#">‚öôÔ∏è Configura√ß√µes</a>

    <hr class="bg-light">
    <a href="/logout" class="text-danger">üö™ Sair</a>
</div>

<!-- üîπ CONTE√öDO -->
<div class="content">

    <!-- HEADER -->
    <div class="d-flex justify-content-between mb-4">
        <h2>Dashboard</h2>
        <span>üë§ {{ session.get("usuario", "admin") }}</span>
    </div>
    <!-- üîç FILTROS -->
    <h5 class="mb-3">üîé Filtros</h5>
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <form method="get" class="row g-3 align-items-end">

                <!-- STATUS -->
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos</option>

                        <option value="pendente"
                            {% if status_selecionado == "pendente" %}selected{% endif %}>
                            Pendente
                        </option>

                        <option value="pago"
                            {% if status_selecionado == "pago" %}selected{% endif %}>
                            Pago
                        </option>
                    </select>
                </div>

                <!-- RESID√äNCIA -->
                <div class="col-md-4">
                    <label class="form-label">Resid√™ncia</label>
                    <select name="residencia" class="form-select" onchange="this.form.submit()">
                        <option value="">Todas</option>

                        {% for r in residencias %}
                        <option value="{{ r }}"
                            {% if residencia_selecionada == r %}selected{% endif %}>
                            {{ r }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- PER√çODO -->
                <div class="col-md-3">
                    <label class="form-label">Per√≠odo</label>
                    <select name="periodo" class="form-select" onchange="this.form.submit()">
                        <option value="">Todos</option>

                        {% for p in periodos %}
                        <option value="{{ p }}"
                            {% if periodo_selecionado == p %}selected{% endif %}>
                            {{ mapa_meses[p[:2]] }}/{{ p[3:] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- LIMPAR -->
                <div class="col-md-2">
                    <a href="/" class="btn btn-secondary w-100">Limpar</a>
                </div>

            </form>

        </div>
    </div>

    <!-- CARDS -->
    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card text-white bg-danger shadow">
                <div class="card-body">
                    <h6>Pendente</h6>
                    <h3>R$ {{ "%.2f"|format(total_pendente) }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-success shadow">
                <div class="card-body">
                    <h6>Pago</h6>
                    <h3>R$ {{ "%.2f"|format(total_pago) }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-primary shadow">
                <div class="card-body">
                    <h6>Total</h6>
                    <h3>{{ total_contas }}</h3>
                </div>
            </div>
        </div>

    </div>

    <!-- TABELA -->
    <div class="card shadow">
        <div class="card-body p-0">

            <table class="table table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <!--<th>ID</th>-->
                        <th>Resid√™ncia</th>
                        <th>Favorecido</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>A√ß√£o</th>
                        <th>PIX</th>
                    </tr>
                </thead>

                <tbody>
                    {% for c in contas %}
                    <tr>
                        <!-- <td>{{ c.id }}</td> -->
                        
                        <td>{{ c.residencia }}</td>
                        <td>{{ c.favorecido }}</td>
                        <td>{{ c.tipo }}</td>
                        <td>
                            <strong>R$ {{ "%.2f"|format(c.valor or 0) }}</strong>
                        </td>
                        <td>{{ c.vencimento }}</td>
                        <td>
                            {% if c.status == 'pago' %}
                                <span class="badge bg-success">Pago</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Pendente</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if c.status != 'pago' %}
                                <a href="/pagar/{{ c.id }}" class="btn btn-sm btn-success">
                                    ‚úî Pagar
                                </a>
                            {% endif %}
                        </td>
                        <td>
                            {% if c.pix_payload %}
                                <button class="btn btn-sm btn-primary"
                                        onclick="abrirQR(`{{ c.pix_payload }}`)">
                                    üî≥ QR
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>

        </div>
    </div>

</div>
<!-- üî≥ MODAL QR -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">

      <div class="modal-header">
        <h5 class="modal-title">Pagamento via PIX</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="qrImage" src="" class="img-fluid mb-3">

        <textarea id="pixCode" class="form-control" rows="3" readonly></textarea>

        <button class="btn btn-secondary mt-2" onclick="copiarPix()">
            üìã Copiar PIX
        </button>
      </div>

    </div>
  </div>
</div>
<script>
function abrirQR(payload) {

    const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(payload);

    document.getElementById("qrImage").src = qrUrl;
    document.getElementById("pixCode").value = payload;

    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
}

function copiarPix() {
    const pix = document.getElementById("pixCode");
    pix.select();
    document.execCommand("copy");
    alert("PIX copiado!");
}
</script>
</body>
</html>